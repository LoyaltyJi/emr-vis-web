<!DOCTYPE html>
<html lang="en" ng-app="myApp">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  
  <title>EMR VisWeb</title>

  <meta name="description" content="">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link rel="stylesheet" href="bower_components/html5-boilerplate/css/normalize.css">
  <link rel="stylesheet" href="bower_components/html5-boilerplate/css/main.css">
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="bower_components/animate.css/animate.min.css">
  <link rel="stylesheet" href="css/app.css"/>
  <link rel="stylesheet" type="text/css" href="css/wordtree-style.css">

</head>

<body class="ng-cloak" ng-controller="appCtrl">

  <div ng-show="appDisabled" id="coverall">
  </div>
  
  <div ng-show="loaderCount > 0" id="appLoading" class="alert alert-warning appNotice">
    <strong>Loading!</strong> Please wait.
  </div>

  <header ng-hide="wordTreeFullscreenButton" class="navbar navbar-default navbar-fixed-top">
    <div class="navbar-header">
      <a class="navbar-brand visible-xs">EMR VisWeb</a>
    </div>
    <nav class="hidden-xs">
      <ul class="nav navbar-nav" ng-click="modal.toggle()">
        <a href="#top" role="button" class="navbar-brand">
          EMR VisWeb
        </a>
        <li>
          <a class="dropdown-toggle">DATASET <i class="glyphicon glyphicon-chevron-down"></i></a> 
          <span class="animated">{{active.dataset | truncate:15}}</span> 
        </li>
        <li>
          <a class="dropdown-toggle">MODEL <i class="glyphicon glyphicon-chevron-down"></i></a> 
          <span>{{active.model | truncate:15}}</span>
        </li>
      </ul>
      <form class="navbar-form navbar-right" role="search">
        <div class="form-group" ng-class="{'search-input-active': searchQuery}">
          <span id="add-on">Doc #</span>
          <input id="search-input" class="form-control" 
                placeholder="Comma separated" type="search" 
                ng-model="searchQuery" ng-blur="loadVarStats(active.variable)"/>
          <span id="search-clear" class="search-clear glyphicon glyphicon-remove-circle" 
                ng-click="setSearchFilter(null)"></span>
        </div>
      </form>
      <div collapse="modal.isCollapsed" id="modal">
        <div class="list">
          <h5>Select Dataset</h5>
          <p ng-hide="datasetList.length" class="empty-list">None</p>
          <ul>
            <li ng-repeat="dataset in datasetList" 
                ng-class="{selected: modal.selectedDataset == dataset.name}" 
                ng-click="modal.selectedDataset = dataset.name">
                {{dataset.name | truncate:20}}
            </li>
          </ul>
        </div>
        <div class="list">
          <h5>Select Model</h5>
          <p ng-hide="modelList.length" class="empty-list">None</p>
          <ul>
            <!-- <li class="pick">Test</li> -->
            <li ng-repeat="model in modelList" 
                ng-class="{selected: modal.selectedModel == model.name}" 
                ng-click="modal.selectedModel = model.name">
                {{model.name | truncate:20}}
            </li>
          </ul>
        </div>
        <div class="modal-footer">
            <button class="btn btn-default" ng-click="modal.toggle()">Cancel</button>
            <button class="btn btn-primary" ng-click="modal.confirm()">Load</button>
        </div>
      </div>
    </nav>
  </header>

<!-- Main container starts here. -->

  <div class="container-fluid">
    <div class="row">

      <!-- Sidebar -->

      <div class="sidebar">
        <div id="sidebar-resize-indicator"></div>

        <!-- Grid -->
        <div id="sidebar-top" class="unselectable">
          <div id="tablecontainer">
            <div id="topbar">
              <div tooltip-placement="right" tooltip-animation="false" tooltip="document identifier" class="colname cellwidth_id">
                <div class="progress">
                </div>
                <a class="rotate"><div>doc #</div></a>
              </div>
              <div class="colname cellwidth_var" 
                  ng-repeat="var in $root.config.variables" 
                  tooltip="{{variableData[var]['percPositive']}}% {{$root.config.classificationName['positive']}}" 
                  tooltip-placement="{{$index > 6 ? 'left' : 'right'}}"
                  tooltip-animation="false">
                    <div class="progress">
                      <div class="progress-bar positive" style="width: {{variableData[var]['percPositive']}}%"></div>
                      <div class="progress-bar negative" style="width: {{variableData[var]['percNegative']}}%"></div>
                    </div>
                    <a class="rotate"><div>{{$root.config.variableMapping[var]}}</div></a>
              </div>
            </div>
            <div class="sidebar-separator breakline resizable" horizontal-splitter>
              <div class="handle"></div>
            </div>
            <div id="grid-table">
              <div class="divrow ng-cloak" 
                  ng-repeat="doc in gridData track by doc.id" 
                  ng-show="!searchQuery || searchQuery.indexOf(doc.id) !== -1">
                    <div class="divcell cellwidth_id">{{doc.id}}</div>
                    <div class="divcell cellwidth_var {{styleGridCell(doc[var].classification, doc[var].confidence)}} custom-tooltip-bottom"  
                        ng-repeat="var in $root.config.variables" 
                        ng-click="updateGrid(var, $parent.$index)" 
                        ng-class="{selected: $parent.$index==active.docIndex && var==active.variable}" 
                        data-custom-tooltip="{{doc[var].confidence}}" 
                        cell-modified="doc[var].classification">
                      {{$root.config.classificationName[ doc[var].classification ]}}
                    </div>
              </div>
            </div>
          </div>
        </div>  
        
        <div class="sidebar-separator resizable" horizontal-splitter>
          <div class="handle"></div>
        </div>

        <div id="sidebar-bottom">

          <!-- Variable details -->
          <div id="sidebar-bottom-left">
            <div class="about unselectable">Variable: <strong>{{$root.config.variableMapping[active.variable]}}</strong></div>
            <div class="content">
              <div id="keywords">
                <h6>{{$root.config.classificationName["positive"]}} indicators</h6>
                <p ng-hide="varStats.topPositive.length" class="empty-list">None</p>
                <ol>
                  <li class="positive clickable" style="width:{{keyword.weight*100}}%;" 
                      ng-repeat="keyword in varStats.topPositive | limitTo: 5" 
                      scroll-to-bookmark="{{keyword.term}}">
                      {{keyword.term}}&nbsp; <span class="d3-tip">({{keyword.weight}})</span>
                  </li>
                </ol>

                <h6>{{$root.config.classificationName["negative"]}} indicators</h6>
                <p ng-hide="varStats.topNegative.length" class="empty-list">None</p>
                <ol>
                  <li class="negative clickable" style="width:{{keyword.weight*100}}%;" 
                      ng-repeat="keyword in varStats.topNegative | limitTo: 5" 
                      scroll-to-bookmark="{{keyword.term}}">
                      {{keyword.term}}&nbsp;<span class="d3-tip">({{keyword.weight}})</span>
                  </li>
                </ol>
              </div>
              <div id="distribution">
                <h6>Distribution</h6>
                <p ng-hide="distData" class="empty-list">None</p>
                <d3-distchart ng-show="distData" data='distData'></d3-distchart>
              </div>
            </div>
          </div>

          <!-- Report details -->
          <div id="sidebar-bottom-right">
            <div class="about unselectable">Doc: <strong>#{{gridData[active.docIndex].id}}</strong></div>
            <div class="content">
              <h6>{{$root.config.classificationName["positive"]}} indicators</h6>
              <p ng-hide="gridData[active.docIndex][active.variable].topPositive.length" class="empty-list">None</p>
              <ol>
                <li class="positive clickable" style="width:{{keyword.weight*100}}%;" 
                    ng-repeat="keyword in gridData[active.docIndex][active.variable].topPositive"  
                    scroll-to-bookmark="{{keyword.term}}">
                    {{keyword.term}}&nbsp;<span class="d3-tip">({{keyword.weight}})</span>
                </li>
              </ol>

              <h6>{{$root.config.classificationName["negative"]}} indicators</h6>
              <p ng-hide="gridData[active.docIndex][active.variable].topNegative.length" class="empty-list">None</p>
              <ol>
                <li class="negative clickable" style="width:{{keyword.weight*100}}%;" 
                    ng-repeat="keyword in gridData[active.docIndex][active.variable].topNegative" 
                    scroll-to-bookmark="{{keyword.term}}" >
                    {{keyword.term}}&nbsp;<span class="d3-tip">({{keyword.weight}})</span>
                </li>
              </ol>
            </div>
          </div>

        </div>

      </div>

      <!-- Document views -->
      <div class="main">

        <!-- Feedback -->
        <div ng-if="tabs.docView && records.report.exists" class="alert alert-warning report-feedback">
          <span ng-if="appInfo">
            {{appInfo}}
          </span>
          <span ng-if="!appInfo">
            <span ng-if="feedbackText">
              <strong>"{{feedbackText|truncate:20}}"</strong> indicates 
              <select ng-model="active.variable" 
                      ng-options="$root.config.variableMapping[var] for var in $root.config.variables" 
                      ng-change="updateGrid(active.variable, active.docIndex)">
              </select> 
              to be: 
                <a ng-click="addFeedbackText('positive')">{{$root.config.classificationName['positive']}}</a> | 
                <a ng-click="addFeedbackText('negative')">{{$root.config.classificationName['negative']}}</a>
            </span>
            <span ng-if="!feedbackText" >
              <select ng-model="active.variable" 
                      ng-options="$root.config.variableMapping[var] for var in $root.config.variables" 
                      ng-change="updateGrid(active.variable, active.docIndex)"></select> 
              is marked as <strong>{{$root.config.classificationName[ gridData[active.docIndex][active.variable].classification ] | lowercase}}</strong> 
              for this record. 
              Label it: 
                <a ng-click="addFeedbackDoc('positive')">{{$root.config.classificationName['positive']}}</a> | 
                <a ng-click="addFeedbackDoc('negative')">{{$root.config.classificationName['negative']}}</a></span>
          </span>
        </div>
        <div ng-if="tabs.wordTreeView && wordTreeData.feedbackText" class="alert alert-warning report-feedback">
          <span ng-if="appInfo">
            {{appInfo}}
          </span>
          <span ng-if="!appInfo">
            <strong>"{{wordTreeData.feedbackText|truncate:20}}"</strong> indicates 
            <select ng-model="active.variable" 
                    ng-options="$root.config.variableMapping[var] for var in $root.config.variables" 
                    ng-change="updateWordTreeClass()"></select> 
            to be: 
              <a ng-click="addWordTreeFeedback('positive')">{{$root.config.classificationName['positive']}}</a> | 
              <a ng-click="addWordTreeFeedback('negative')">{{$root.config.classificationName['negative']}}</a>
          </span>
        </div>

        <tabset>

          <!-- Report view -->
          <tab active="tabs.docView" heading="Document View">
            <div ng-show="records.pathology.exists" class="pagerview">
              <div class="pagerview-row">
                  <div class="pagerview-step">
                      <button type="button" scroll-to-bookmark="records.report.text" class="btn btn-default btn-circle">1</button>
                      <p class="clickable" scroll-to-bookmark="records.report.text">Report</p>
                  </div>
                  <div class="pagerview-step">
                      <button type="button" scroll-to-bookmark="records.pathology.text" class="btn btn-default btn-circle">2</button>
                      <p class="clickable" scroll-to-bookmark="records.pathology.text">Pathology</p>
                  </div>
              </div>
            </div>
            <span ng-context-menu="feedbackContextMenu">
              <div scroll-bookmark="records.report.text" ng-mouseup="setFeedbackText()" ng-if="records.report.exists" id="emr-report" class="report">
                <div class="info">
                  <i class="glyphicon glyphicon-list-alt"></i>&nbsp;
                  <a tooltip-placement="bottom" tooltip-animation="false" tooltip="docs/{{gridData[active.docIndex].id}}/report.txt">
                    <strong class="file-name js-selectable-text">Report: #{{gridData[active.docIndex].id}}</strong>
                  </a>
                  <a class="btn btn-xs btn-default pull-right" ng-click="PrintReport('emr-report')"><strong>Print</strong></a>
                </div>
                <pre>
                  <highlighted-report data='records.report.text' 
                                      pos-terms='gridData[active.docIndex][active.variable].topPositive' 
                                      neg-terms='gridData[active.docIndex][active.variable].topNegative'>
                  </highlighted-report>
                </pre>
              </div>
              <div scroll-bookmark="records.pathology.text" ng-mouseup="setFeedbackText()" ng-if="records.pathology.exists" id="emr-pathology" class="report">
                <div class="info">
                  <i class="glyphicon glyphicon-list-alt"></i>&nbsp;
                  <a tooltip-placement="bottom" tooltip-animation="false" tooltip="docs/{{gridData[active.docIndex].id}}/pathology.txt"> 
                    <strong class="file-name js-selectable-text">Pathology: #{{gridData[active.docIndex].id}}</strong>
                  </a>
                  <a class="btn btn-xs btn-default pull-right" ng-click="PrintReport('emr-pathology')"><strong>Print</strong></a>
                </div>
                <pre>
                  <highlighted-report data='records.pathology.text' 
                                      pos-terms='gridData[active.docIndex][active.variable].topPositive' 
                                      neg-terms='gridData[active.docIndex][active.variable].topNegative'>
                  </highlighted-report></pre>
              </div>
            </span>
          </tab>

          <!-- WordTree view -->
          <tab active="tabs.wordTreeView" select="setWordTreeHeight()" heading="WordTree View">
            <form ng-submit="loadWordTree()" id="wordtree-search">
              <div class="row">
                <div class="input-group">
                  <span class="input-group-addon">
                  Variable &nbsp; 
                    <select id="wordtree-select-variable" 
                      ng-model="active.variable" 
                      ng-options="$root.config.variableMapping[var] for var in $root.config.variables" 
                      ng-change="updateWordTreeClass()"
                      ></select> 
                  </span>
                  <input id="wordtree-input" type="text" class="form-control wordtree-search-control" placeholder="Select variable and enter keywords here&hellip;" required>
                  <span class="input-group-btn">
                      <button type="submit" class="btn btn-default wordtree-search-control">Search</button>
                  </span>
                </div>
                <span id="wordtree-search-clear" class="search-clear glyphicon glyphicon-remove-circle" 
                      ng-click="clearWordTree()">
                </span>
              </div>
            </form>
            <div id="wordtree-popup" ng-class="{'wordtree-popup-overlay': wordTreeFullscreenButton}">
            </div>
            <div id="wordtree-view" 
              ng-class="{'wordtree-view-overlay': wordTreeFullscreenButton}" 
              ng-context-menu="feedbackContextMenu">
                <div id="wordtree-container" class="wordtree-container-class">
                  <p id="wordtree-empty">
                    No wordtree to show. Enter keywords above and search.
                  </p>
                </div>
            </div>
            <div id="wordtree-about"
                  ng-show="wordTreeData.matches" 
                  ng-class="{'wordtree-about-overlay': wordTreeFullscreenButton}">
                  <button id="wordtree-fullscreen-button" type="button" class="btn btn-xs btn-default" btn-checkbox
                          ng-model="singleModel"  
                          ng-click="toggleWordTreeFullscreen()" 
                          ng-class="{'wordtree-fullscreen-button-overlay': wordTreeFullscreenButton}">
                          <span class="glyphicon glyphicon-fullscreen"></span>
                  </button>
                  <span id="wordtree-about-info">
                    Documents: <strong>{{wordTreeData.percentage}}% ({{wordTreeData.matches}} of {{wordTreeData.total}}) </strong>
                  </span>
            </div>
          </tab>

          <!-- Retrain view -->
          <tab>
            <tab-heading>
              <i class="glyphicon glyphicon-refresh"></i> Re-Train &nbsp;<span ng-if="feedbackList.length > 0" class="badge alert-info pull-right animated bounceIn"> {{feedbackList.length}} </span>
            </tab-heading>
            <div class="tab-inner-content">
              <h4>Feedback List</h4>
              <div id="feedbackList">
                <p ng-hide="feedbackList.length">Feedback list is empty.</p>
                
                <alert ng-repeat="feedback in feedbackList" type="default" close="removeFeedback($index)">
                  <strong>{{$index + 1}}.</strong>
                  <span ng-if="feedback.kind == 'TYPE_DOC'">
                    #{{feedback.docList}} should have 
                    <strong>{{$root.config.variableMapping[feedback.variable]}}</strong> 
                    marked as <strong>{{$root.config.classificationName[feedback.classification] | lowercase}}</strong>.
                  </span>
                  <span ng-if="feedback.kind == 'TYPE_TEXT' || feedback.kind == 'TYPE_WORDTREE'">
                    "<em>{{feedback.selected}}</em>" indicates 
                    <strong>{{$root.config.variableMapping[feedback.variable]}}</strong> 
                    to be <strong>{{$root.config.classificationName[feedback.classification] | lowercase}}</strong>.
                  </span>
                </alert>
                
                <div class="form-horizontal" ng-show="feedbackList.length">
                  <button class="btn btn-default"
                          on-confirm-click="clearFeedback()" confirm-click="Do you wish to clear all feedback?">
                    <i class="glyphicon glyphicon-trash"> </i> Clear All
                  </button>
                  <button class="btn btn-primary" 
                          ng-click="confirmFeedback(feedbackOverride)" >
                          <i class="glyphicon glyphicon-refresh"> </i> Re-Train
                  </button>
                  <label>
                    <input type="checkbox" ng-model="feedbackOverride" class="ng-valid ng-dirty"> Override [<a href="#" tooltip="Use this switch to override any conflicts and warnings about existing training data." tooltip-animation="false" tooltip-placement="right">?</a>]                  
                  </label>
                </div>
              </div>

              <div ng-show="retrainData.message || retrainData.loading">
                <hr />
                <h4>Training Results</h4>
                <p ng-show="retrainData.loading">
                  <span><i class='glyphicon glyphicon-refresh spin'></i></span> 
                  Re-training models. Please wait.
                </p>
                <div ng-hide="retrainData.loading">
                  <p>
                    <span class="glyphicon glyphicon-ok" ng-show="retrainData.successful"></span>
                    <span class="glyphicon glyphicon-remove" ng-show="!retrainData.successful"></span>
                    {{retrainData.message}} 
                    <span ng-show="retrainData.successful">
                      Now using <strong>{{active.model}}</strong>.
                    </span>
                  </p>

                  <div ng-show="retrainData.successful">
                    <p>It includes the following feedback:</p>
                    <ol>
                      <li ng-repeat="feedback in retrainData.feedbackList">
                        <span ng-if="feedback.kind == 'TYPE_DOC'">
                          #{{feedback.docList}} should have 
                          <strong>{{$root.config.variableMapping[feedback.variable]}}</strong> 
                          marked as <strong>{{$root.config.classificationName[feedback.classification] | lowercase}}</strong>.</span>
                        <span ng-if="feedback.kind == 'TYPE_TEXT' || feedback.kind == 'TYPE_WORDTREE'">
                          "<em>{{feedback.selected}}</em>" indicates 
                          <strong>{{$root.config.variableMapping[feedback.variable]}}</strong> 
                          to be <strong>{{$root.config.classificationName[feedback.classification] | lowercase}}</strong>.
                        </span>
                      </li>
                    </ol>
                  </div>
                </div>
              </div>

            </div>
          </tab>
        </tabset>

      </div>
    </div>
  </div>

  <!-- In production use:
  <script src="//ajax.googleapis.com/ajax/libs/angularjs/x.x.x/angular.min.js"></script>
  -->
  <!-- Do not change the order -->
  <script src="bower_components/angular/angular.js"></script>
  <script src="bower_components/angular-bootstrap/ui-bootstrap-tpls.min.js"></script>
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="bower_components/d3/d3.min.js"></script>
  <script src="bower_components/jquery.scrollTo/jquery.scrollTo.min.js"></script>
  <script src="js/app.js"></script>
  <script src="js/services.js"></script>
  <script src="js/controllers.js"></script>
  <script src="js/filters.js"></script>
  <script src="js/directives.js"></script>
  <script src="js/report-highlight.js"></script>
  <script src="js/jquery-routines.js"></script>
  <!-- After angular controllers -->
  <script src="js/wordtree-controller.js"></script> 
  <script src="js/wordtree-layout.js"></script> 
</body>
</html>
  
